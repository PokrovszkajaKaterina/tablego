---
- name: Deploy TableGo Angular Application to Test Environment
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    app_name: tablego
    source_dir: "{{ playbook_dir }}/../../client/tablego/dist/my-first-project/browser"
    nginx_config: "{{ playbook_dir }}/../nginx.conf"

  tasks:
    - name: Get current timestamp
      set_fact:
        deploy_timestamp: "{{ ansible_date_time.iso8601 }}"

    - name: Display deployment information
      debug:
        msg: "Deploying {{ app_name }} at {{ deploy_timestamp }}"

    - name: Find nginx container name
      shell: "docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep -E '(tablego-test|server-tablego-test)' | head -1"
      register: nginx_container_result
      ignore_errors: yes

    - name: Set nginx container name
      set_fact:
        nginx_container: "{{ nginx_container_result.stdout }}"

    - name: Display found container name
      debug:
        msg: "Found nginx container: {{ nginx_container }}"

    - name: Fail if container is not running
      fail:
        msg: "Nginx container not found! Make sure tablego-test container is running."
      when: nginx_container == ""

    - name: Remove old application files from nginx
      shell: "docker exec {{ nginx_container }} rm -rf /usr/share/nginx/html/*"

    - name: Copy built application files to nginx container
      shell: "docker cp {{ source_dir }}/. {{ nginx_container }}:/usr/share/nginx/html/"

    - name: Copy nginx configuration
      shell: "docker cp {{ nginx_config }} {{ nginx_container }}:/etc/nginx/conf.d/default.conf"

    - name: Reload nginx to apply new configuration
      shell: "docker exec {{ nginx_container }} nginx -s reload"

    - name: Display deployment success message
      debug:
        msg: "âœ… Deployment successful! Application will be verified in next stage."

    - name: Log deployment to file
      lineinfile:
        path: /var/jenkins_home/deployment-log.txt
        line: "{{ deploy_timestamp }} - Build #{{ lookup('env', 'BUILD_NUMBER') | default('manual', true) }} - SUCCESS"
        create: yes
      ignore_errors: yes